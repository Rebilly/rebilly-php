name: Updates SDK based on api-definitions

on: 
  workflow_dispatch:
    inputs:
      trigger-reason:
        description: |
          The comment that will be posted to the PR if any changes are added.
          Used to provide context about the source of the update.
        required: false

jobs:
  generate-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout api-definitions repo
        uses: actions/checkout@v3
        with:
          path: 'api-definitions'
          repository: 'Rebilly/api-definitions'

      - uses: actions/checkout@v3
        with:
          ref: 'v3.x'
          path: 'sdk'

      - uses: actions/checkout@v3
        with:
          token: '${{ secrets.MACHINE_USER_PAT }}'
          path: 'generator'
          repository: 'Rebilly/rebilly'
          sparse-checkout: |
            backend/php-sdk-generator/remove-fqcns.php
            backend/php-sdk-generator/remove-unused-models.php
          sparse-checkout-cone-mode: true

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, curl, json
          tools: composer:v2

      - name: Install api-definitions dependencies
        working-directory: ./api-definitions
        run: npm install

      - name: Build api-definitions
        working-directory: ./api-definitions
        run: npx redocly build all@latest -o dist/all

      - name: Login to registry
        run: |
          echo ${{ secrets.MACHINE_USER_PAT }} | docker login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Build SDK
        run: |
          mkdir /tmp/sdk
          docker run --rm \
            -u $(id -u ${USER}):$(id -g ${USER}) \
            -v "/tmp/sdk:/out" \
            -v "./api-definitions/dist:/api-definitions" \
            -v "./api-definitions/plugins/products-bundler/mapping:/bundle-mapping" \
            ghcr.io/rebilly/php-sdk-generator:latest generate \
            --skip-validate-spec \
            -g php-8.0-client \
            -o /out \
            -c /config.yaml \
            -i "/api-definitions/all.yaml' \
            --additional-properties=serviceName=${{ steps.prep.outputs.service-name }} \
            --additional-properties=resourceMapping=/shared/custom-resource-names.json \
            --additional-properties=resourceMappingSegment=${{ steps.prep.outputs.mapping-segment }}

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Bundle SDK
        run: |
          rm -rf ./sdk/{tests,src,composer.json,.php-cs-fixer.php} && \
          cp -r /tmp/sdk/{tests,src,composer.json,.php-cs-fixer.php} ./sdk/
          php ./generator/backend/php-sdk-generator/remove-fqcns.php ./sdk && \
          php ./generator/backend/php-sdk-generator/remove-unused-models.php ./sdk

      - name: Install composer dependencies
        working-directory: ./sdk
        run: composer install --prefer-dist

      - name: CS fix SDK
        working-directory: ./sdk
        run: composer cs-fix

      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          # Path of the checked-out repo where we placed the generated resources  
          path: 'sdk'
          token: ${{ secrets.MACHINE_USER_PAT }}
          title: 'chore: update SDK from api-definitions'
          commit-message: update SDK from api-definitions
          branch: automations/update-sdk-from-api-definitions
          base: v3.x
          # Delete the branch when closing PRs or merging
          delete-branch: true
          body: This PR is automatically generated and updates SDK based on a change in the API definitions

      - name: Comment trigger reason
        uses: marocchino/sticky-pull-request-comment@v2
        if: |
          (steps.cpr.outputs.pull-request-operation == 'created' ||
          steps.cpr.outputs.pull-request-operation == 'updated') &&
          github.event.inputs.trigger-reason != ''
        with:
          GITHUB_TOKEN: ${{ secrets.MACHINE_USER_PAT }}
          append: true
          number: ${{ steps.cpr.outputs.pull-request-number }}
          message: |
            Triggered due to: ${{ github.event.inputs.trigger-reason }}
